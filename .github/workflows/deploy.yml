name: Build and Deploy to k3s

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual trigger

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract metadata (tags, labels)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy:
    name: Deploy to k3s
    runs-on: [self-hosted, k3s]
    needs: build-and-push
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Verify cluster connection
        run: |
          kubectl cluster-info
          kubectl get nodes
      
      - name: Install External Secrets Operator
        run: |
          helm repo add external-secrets https://charts.external-secrets.io
          helm repo update
          
          if ! helm list -n external-secrets-system | grep -q external-secrets; then
            helm install external-secrets \
              external-secrets/external-secrets \
              -n external-secrets-system \
              --create-namespace \
              --set installCRDs=true
          else
            echo "External Secrets Operator already installed"
          fi

          # Always wait for External Secrets Operator to be ready
          echo "Waiting for External Secrets Operator to be ready..."
          kubectl wait --for=condition=ready pod \
            -l app.kubernetes.io/name=external-secrets \
            -n external-secrets-system \
            --timeout=120s

          # Wait for CRDs to be fully registered
          echo "Waiting for CRDs to be registered..."
          sleep 5
      
      - name: Create namespace
        run: |
          kubectl apply -f k8s/namespace.yaml
      
      - name: Create AWS credentials secret
        run: |
          kubectl create secret generic aws-credentials \
            --namespace=evite \
            --from-literal=access-key-id="${{ secrets.AWS_ACCESS_KEY_ID }}" \
            --from-literal=secret-access-key="${{ secrets.AWS_SECRET_ACCESS_KEY }}" \
            --dry-run=client -o yaml | kubectl apply -f -
      
      - name: Deploy External Secrets
        run: |
          kubectl apply -f k8s/secretstore.yaml
          kubectl apply -f k8s/externalsecret-app.yaml
          kubectl apply -f k8s/externalsecret-postgres.yaml
          kubectl apply -f k8s/externalsecret-config.yaml
          
          echo "Waiting for secrets to sync..."
          sleep 15
          
          kubectl get externalsecrets -n evite
          kubectl get secrets -n evite
      
      - name: Deploy PostgreSQL
        run: |
          kubectl apply -f k8s/postgres-pvc.yaml
          kubectl apply -f k8s/postgres-statefulset.yaml
          kubectl apply -f k8s/postgres-service.yaml
          
          echo "Waiting for PostgreSQL to be ready..."
          kubectl wait --for=condition=ready pod \
            -l app=postgres \
            -n evite \
            --timeout=300s || true
      
      - name: Deploy Application
        run: |
          kubectl apply -f k8s/app-deployment.yaml
          kubectl apply -f k8s/app-service.yaml
          kubectl apply -f k8s/middleware.yaml
          kubectl apply -f k8s/ingressroute.yaml

          echo "Waiting for application to be ready..."
          kubectl wait --for=condition=ready pod \
            -l app=evite \
            -n evite \
            --timeout=300s || true
      
      - name: Deployment Summary
        run: |
          echo "========================================="
          echo "Deployment Complete!"
          echo "========================================="
          echo ""
          echo "Pods:"
          kubectl get pods -n evite
          echo ""
          echo "Services:"
          kubectl get svc -n evite
          echo ""
          echo "IngressRoutes:"
          kubectl get ingressroute -n evite
          echo ""
          echo "Application URL: https://invitatie.dotsat.work"

